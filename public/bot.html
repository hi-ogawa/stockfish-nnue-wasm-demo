<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <title>Lichess Bot</title>
  <meta
    name="viewport"
    content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <link
    rel="icon"
    href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSI0NSIgaGVpZ2h0PSI0NSI+CiAgPGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+CiAgICA8cGF0aAogICAgICBkPSJNIDIyLDEwIEMgMzIuNSwxMSAzOC41LDE4IDM4LDM5IEwgMTUsMzkgQyAxNSwzMCAyNSwzMi41IDIzLDE4IgogICAgICBzdHlsZT0iZmlsbDojMDAwMDAwOyBzdHJva2U6IzAwMDAwMDsiIC8+CiAgICA8cGF0aAogICAgICBkPSJNIDI0LDE4IEMgMjQuMzgsMjAuOTEgMTguNDUsMjUuMzcgMTYsMjcgQyAxMywyOSAxMy4xOCwzMS4zNCAxMSwzMSBDIDkuOTU4LDMwLjA2IDEyLjQxLDI3Ljk2IDExLDI4IEMgMTAsMjggMTEuMTksMjkuMjMgMTAsMzAgQyA5LDMwIDUuOTk3LDMxIDYsMjYgQyA2LDI0IDEyLDE0IDEyLDE0IEMgMTIsMTQgMTMuODksMTIuMSAxNCwxMC41IEMgMTMuMjcsOS41MDYgMTMuNSw4LjUgMTMuNSw3LjUgQyAxNC41LDYuNSAxNi41LDEwIDE2LjUsMTAgTCAxOC41LDEwIEMgMTguNSwxMCAxOS4yOCw4LjAwOCAyMSw3IEMgMjIsNyAyMiwxMCAyMiwxMCIKICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IiAvPgogICAgPHBhdGgKICAgICAgZD0iTSA5LjUgMjUuNSBBIDAuNSAwLjUgMCAxIDEgOC41LDI1LjUgQSAwLjUgMC41IDAgMSAxIDkuNSAyNS41IHoiCiAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7IHN0cm9rZTojZmZmZmZmOyIgLz4KICAgIDxwYXRoCiAgICAgIGQ9Ik0gMTUgMTUuNSBBIDAuNSAxLjUgMCAxIDEgIDE0LDE1LjUgQSAwLjUgMS41IDAgMSAxICAxNSAxNS41IHoiCiAgICAgIHRyYW5zZm9ybT0ibWF0cml4KDAuODY2LDAuNSwtMC41LDAuODY2LDkuNjkzLC01LjE3MykiCiAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7IHN0cm9rZTojZmZmZmZmOyIgLz4KICAgIDxwYXRoCiAgICAgIGQ9Ik0gMjQuNTUsMTAuNCBMIDI0LjEsMTEuODUgTCAyNC42LDEyIEMgMjcuNzUsMTMgMzAuMjUsMTQuNDkgMzIuNSwxOC43NSBDIDM0Ljc1LDIzLjAxIDM1Ljc1LDI5LjA2IDM1LjI1LDM5IEwgMzUuMiwzOS41IEwgMzcuNDUsMzkuNSBMIDM3LjUsMzkgQyAzOCwyOC45NCAzNi42MiwyMi4xNSAzNC4yNSwxNy42NiBDIDMxLjg4LDEzLjE3IDI4LjQ2LDExLjAyIDI1LjA2LDEwLjUgTCAyNC41NSwxMC40IHogIgogICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6bm9uZTsiIC8+CiAgPC9nPgo8L3N2Zz4K"
  />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Roboto+Mono"
  />
</head>

<!-- CSS -->

<style>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    border: 0;
    font: inherit;
  }

  html,
  body,
  #root {
    height: 100%;
  }

  #root {
    font-family: "Roboto Mono";
    font-size: 13px;
  }

  main {
    height: 100%;
    padding: 10px;
    display: flex;
    flex-direction: column;
  }

  main div:not(:last-child) {
    margin-bottom: 5px;
  }

  .ui-input {
    height: 22px;
    padding: 2px 0 2px 6px;
    border: 1px solid #ddd;
  }

  .ui-button {
    height: 22px;
    display: inline-block;
    padding: 1px 6px 1px 6px;
    background: #888;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
  }

  .ui-button--disabled {
    background: #aaa;
    color: #eee;
    cursor: not-allowed;
  }

  #log {
    flex: 1 1 auto;
    width: 100%;
    border: 1px solid #ddd;
    padding: 10px;
    overflow: scroll;
    box-shadow: inset 1px 1px 2px #eee;
    font-size: 11px;
  }
</style>

<!-- Javascript -->

<body>
  <div id="root"></div>

  <script src="./lib/stockfish.js"></script>
  <script src="./bot.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mithril@2.0.4/mithril.min.js"></script>

  <script>
    const $ = (...args) => document.querySelector(...args);

    const repr = (x) => {
      if (typeof x === "string") return x;
      return JSON.stringify(x, null, 2);
    };

    const stringifyToLine = (obj) =>
      JSON.stringify(obj, null, 1).replace(/\n/g, "");

    const App = () => {
      let user_id;
      let is_invalid_key = false;
      let is_verified = false;
      let is_bot = false;
      let is_running = false;
      let log = "";
      let api;
      let stockfish;
      let bot;
      let tail_mode = true;
      let default_api_key = window.localStorage.getItem("api-key");
      let challenge = {
        username: "ai",
        level: 7,
        rated: false,
        "clock.limit": 180,
        "clock.increment": 1,
        color: "random",
      };

      const writeLog = (...args) => {
        for (const arg of args) {
          log += repr(arg) + " ";
        }
        log += "\n";
        // TODO: Probably, better to mutate $("#log") by ourselves (e.g. by appendChild)
        m.redraw();
      };

      const scrollLog = () => {
        if (!tail_mode) {
          return;
        }
        $("#log").scrollTo({ top: $("#log").scrollHeight, behavior: "smooth" });
      };

      const onVerify = () => {
        const key = $("#api-key").value;
        api = new Api(key);
        writeLog("[Api.account]");
        api
          .account()
          .then(
            (resp) => {
              writeLog(resp);
              is_invalid_key = false;
              is_verified = true;
              user_id = resp.id;
              is_bot = resp.title === "BOT";
              window.localStorage.setItem("api-key", key);
            },
            (e) => {
              writeLog("ERROR", e.toString());
              console.error(e);
              is_invalid_key = true;
            }
          )
          .finally(m.redraw);
      };

      const onUpgrade = () => {
        writeLog("[Api.upgrade]");
        api
          .upgrade()
          .then(
            (resp) => {
              writeLog(resp);
              is_bot = true;
            },
            (e) => {
              writeLog("ERROR", e.toString());
              console.error(e);
            }
          )
          .finally(m.redraw);
      };

      const onStart = async () => {
        try {
          writeLog(":: Loading Stockfish...");
          stockfish = await Stockfish();
          writeLog(":: Starting Bot...");
          bot = new Bot(api, stockfish, writeLog);
          is_running = true;
          await bot.start();
        } catch (e) {
          writeLog("ERROR", e.toString());
          console.error(e);
        }
        m.redraw();
      };

      const onEditChallenge = () => {
        const default_value = stringifyToLine(challenge);
        const result = window.prompt("Edit Challenge", default_value);
        if (!result) {
          return;
        }
        challenge = JSON.parse(result);
        m.redraw();
      };

      const onSendChallenge = () => {
        writeLog("[Api.createChallenge]");
        api
          .createChallenge(challenge.username, challenge)
          .then(
            (resp) => {
              writeLog(resp);
            },
            (e) => {
              writeLog("ERROR", e.toString());
              console.error(e);
            }
          )
          .finally(m.redraw);
      };

      const oncreate = () => {
        if (default_api_key) {
          $("#api-key").value = default_api_key;
        }
      };

      const view = () => {
        const upgrade_enabled = is_verified && !is_bot;
        const start_enabled = is_bot && !is_running;
        const stop_enabled = is_running;
        const challenge_enabled = is_running;

        return m("main", [
          m("div", [
            m("span", "API Key: "),
            m("input#api-key.ui-input", {
              style: "width: 150px; border-right: 0;",
            }),
            m("button.ui-button", { onclick: onVerify }, "Check"),
            " ",
            "(",
            m(
              "a",
              { href: "https://lichess.org/api#operation/botAccountUpgrade" },
              "help"
            ),
            ")",
          ]),
          m("div", [
            m("span", "Status: "),
            m(
              "span",
              is_invalid_key
                ? "API key is invalid."
                : !is_verified
                ? "API key is not verified."
                : is_bot
                ? `Account (${user_id}) is a bot.`
                : `Account (${user_id}) is not a bot.`
            ),
            " ",
            m(
              "button.ui-button",
              upgrade_enabled
                ? { onclick: onUpgrade }
                : { class: "ui-button--disabled" },
              "Become Bot"
            ),
            " ",
            m(
              "button.ui-button",
              start_enabled
                ? { onclick: onStart }
                : { class: "ui-button--disabled" },
              "Start"
            ),
          ]),
          m("div", [
            m("span", "Challenge: "),
            m("span", stringifyToLine(challenge)),
            " ",
            m("button.ui-button", { onclick: onEditChallenge }, "Edit"),
            " ",
            m(
              "button.ui-button",
              challenge_enabled
                ? { onclick: onSendChallenge }
                : { class: "ui-button--disabled" },
              "Send"
            ),
            " ",
            "(",
            m(
              "a",
              { href: "https://lichess.org/api#operation/challengeCreate" },
              "help"
            ),
            ")",
          ]),
          m("div", [
            m("span", "Scroll log: "),
            m(
              "span",
              {
                style: "cursor: pointer;",
                onclick: () => {
                  tail_mode = !tail_mode;
                  scrollLog();
                },
              },
              [tail_mode ? "[x]" : "[ ]"]
            ),
          ]),
          m(
            "div#log",
            { onupdate: () => window.setTimeout(scrollLog) },
            m("pre", log)
          ),
        ]);
      };

      return { oncreate, view };
    };

    const isSupported = () => {
      if (typeof WebAssembly !== "object") return false;
      const source = Uint8Array.from([
        0, 97, 115, 109, 1, 0, 0, 0, 1, 5, 1, 96, 0, 1, 123, 3, 2, 1, 0, 7, 8,
        1, 4, 116, 101, 115, 116, 0, 0, 10, 15, 1, 13, 0, 65, 0, 253, 17, 65, 0,
        253, 17, 253, 186, 1, 11,
      ]);
      if (
        typeof WebAssembly.validate !== "function" ||
        !WebAssembly.validate(source)
      )
        return false;
      if (typeof Atomics !== "object") return false;
      if (typeof SharedArrayBuffer !== "function") return false;
      return true;
    };

    if (!isSupported()) {
      window.alert(
        "Your browser is not supported. For more information, please take a look at https://github.com/hi-ogawa/Stockfish/wiki."
      );
    } else {
      m.mount($("#root"), App);
    }
  </script>
</body>
